<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãŠæ•£æ­©ã‚¢ãƒ—ãƒª ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—</title>
    <!-- Tailwind CSS CDNã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSSã‚’èª­ã¿è¾¼ã¿ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIINfQPDWS6rzY4Jp+Vill7zLwWH1T3SnyJ"
        crossorigin=""/>
    <!-- Leaflet JavaScriptã‚’èª­ã¿è¾¼ã¿ (ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚ˆã‚Šå‰ã«é…ç½®) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20n6fxyVRPxIKz+gLIQWlYw+rPNm/VREx3T89w+DGaQ="
        crossorigin="anonymous"></script>
    <style>
        /* Interãƒ•ã‚©ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ï¼ˆTailwindã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã ãŒæ˜ç¤ºçš„ã«ï¼‰ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f8ff; /* æ·¡ã„é’ã®èƒŒæ™¯ */
        }
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        #map {
            height: 320px; /* ã“ã“ã§å›ºå®šã®é«˜ã•ã‚’æŒ‡å®šï¼ */
            width: 100%;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            background-color: #e0e0e0; /* åœ°å›³èª­ã¿è¾¼ã¿ä¸­ã®èƒŒæ™¯è‰² */
            display: block;
            /* opacityã¨transitionã¯JavaScriptã§åˆ¶å¾¡ã™ã‚‹ãŸã‚CSSã‹ã‚‰ã¯å‰Šé™¤ */
        }
        /* map.loaded ã‚¯ãƒ©ã‚¹ã¯JavaScriptã§è¿½åŠ ãƒ»å‰Šé™¤ */
        #map.loaded {
            opacity: 1; /* èª­ã¿è¾¼ã¿å®Œäº†å¾Œã€ä¸é€æ˜ã« */
            transition: opacity 0.5s ease-in-out; /* ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        }
        .scroll-container {
            max-height: 150px; /* æ¡ˆå†…ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ã®é«˜ã•åˆ¶é™ */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* iOSã§ã®ã‚¹ãƒ ãƒ¼ã‚ºãªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
        }
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆä»»æ„ï¼‰ */
        .scroll-container::-webkit-scrollbar {
            width: 8px;
        }
        .scroll-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .scroll-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .scroll-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã‚’æœ€å‰é¢ã« */
        #messageBox {
            z-index: 9999; /* ã©ã‚“ãªè¦ç´ ã‚ˆã‚Šã‚‚æ‰‹å‰ã«è¡¨ç¤º */
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4 sm:p-6 bg-gradient-to-br from-blue-100 to-purple-100">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="w-full max-w-2xl bg-gradient-to-r from-purple-500 to-pink-500 text-white p-5 rounded-xl shadow-lg mb-6 text-center">
        <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight">
            ãŠæ•£æ­©ã‚¢ãƒ—ãƒª ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ— ğŸš¶â€â™€ï¸âœ¨
        </h1>
        <p class="mt-2 text-lg sm:text-xl font-medium">
            æ­©ããŸã„è·é›¢ã‚’å…¥åŠ›ã—ã¦ã€æ–°ã—ã„ãƒ«ãƒ¼ãƒˆã‚’è¦‹ã¤ã‘ã‚ˆã†ï¼
        </p>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="w-full max-w-2xl bg-white p-6 rounded-xl shadow-xl space-y-6">

        <!-- è·é›¢å…¥åŠ›ã¨ãƒœã‚¿ãƒ³ -->
        <section class="flex flex-col sm:flex-row items-center justify-center gap-4">
            <input
                type="number"
                id="distanceInput"
                placeholder="æ­©ããŸã„è·é›¢ (km) ã‚’å…¥åŠ›ã—ã¦ã­ï¼"
                class="flex-grow w-full sm:w-auto p-3 border-2 border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg text-gray-700 placeholder-gray-400 font-medium"
                min="0.1"
                step="0.1"
            >
            <button
                id="generateRouteButton"
                class="w-full sm:w-auto bg-gradient-to-r from-green-400 to-blue-500 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:from-green-500 hover:to-blue-600 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-300"
            >
                ãƒ«ãƒ¼ãƒˆã‚’ç”Ÿæˆã™ã‚‹ï¼ğŸ—ºï¸
            </button>
        </section>

        <!-- åœ°å›³è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <section class="relative w-full rounded-xl shadow-md overflow-hidden bg-gray-200 flex items-center justify-center">
            <div id="map" class="w-full"></div>
            <!-- åœ°å›³èª­ã¿è¾¼ã¿ä¸­ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
            <div id="mapLoading" class="absolute inset-0 flex items-center justify-center bg-gray-200 bg-opacity-75 text-gray-600 font-bold text-xl z-10">
                åœ°å›³ã‚’èª­ã¿è¾¼ã¿ä¸­... ğŸŒ
            </div>
        </section>

        <!-- éŸ³å£°æ¡ˆå†…ã¨æ¡ˆå†…è¡¨ç¤º -->
        <section class="bg-white p-5 rounded-xl shadow-md border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">
                éŸ³å£°æ¡ˆå†… ğŸ—£ï¸
            </h2>
            <div id="guidanceDisplay" class="scroll-container bg-blue-50 p-4 rounded-lg border border-blue-200 text-gray-700 text-base leading-relaxed mb-4">
                <p class="text-center text-gray-500">ãƒ«ãƒ¼ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã¨ã€ã“ã“ã«æ¡ˆå†…ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆï¼</p>
            </div>
            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <button
                    id="startGuidanceButton"
                    class="w-full sm:w-auto bg-gradient-to-r from-orange-400 to-red-500 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:from-orange-500 hover:to-red-600 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-orange-300"
                    disabled
                >
                    ãŠæ•£æ­©ã‚¹ã‚¿ãƒ¼ãƒˆï¼â–¶ï¸
                </button>
                <button
                    id="nextGuidanceButton"
                    class="w-full sm:w-auto bg-gradient-to-r from-purple-400 to-indigo-500 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:from-purple-500 hover:to-indigo-600 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-300"
                    disabled
                >
                    æ¬¡ã®æ¡ˆå†…ã¸ï¼ğŸ‘‰
                </button>
            </div>
        </section>

        <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ -->
        <div id="messageBox" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-8 rounded-xl shadow-2xl text-center max-w-sm mx-4">
                <p id="messageText" class="text-xl font-semibold text-gray-800 mb-6"></p>
                <button id="closeMessageBox" class="bg-blue-500 text-white font-bold py-3 px-6 rounded-full hover:bg-blue-600 transition duration-200">OKï¼</button>
            </div>
        </div>

    </main>

    <script>
        // DOMè¦ç´ ã®å–å¾—
        const distanceInput = document.getElementById('distanceInput');
        const generateRouteButton = document.getElementById('generateRouteButton');
        const guidanceDisplay = document.getElementById('guidanceDisplay');
        const startGuidanceButton = document.getElementById('startGuidanceButton');
        const nextGuidanceButton = document.getElementById('nextGuidanceButton');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const closeMessageBox = document.getElementById('closeMessageBox');
        const mapLoading = document.getElementById('mapLoading');

        let currentRouteGuidance = []; // ç”Ÿæˆã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆæ¡ˆå†…ãƒ†ã‚­ã‚¹ãƒˆã®é…åˆ—
        let currentGuidanceIndex = 0; // ç¾åœ¨ã®æ¡ˆå†…ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

        let map; // Leafletãƒãƒƒãƒ—ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
        let userMarker; // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
        let routePolyline; // ãƒ«ãƒ¼ãƒˆã®ãƒãƒªãƒ©ã‚¤ãƒ³ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
        let nextTargetMarker; // æ¬¡ã®æ¡ˆå†…åœ°ç‚¹ãƒãƒ¼ã‚«ãƒ¼ã‚’ä¿æŒã™ã‚‹å¤‰æ•°

        let watchId = null; // Geolocation.watchPositionã®ID

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function showMessageBox(message) {
            messageText.textContent = message;
            mapLoading.classList.add('hidden'); // ãƒ­ãƒ¼ãƒ‰è¡¨ç¤ºã‚’éš ã™
            messageBox.classList.remove('hidden');
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã‚’é–‰ã˜ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        closeMessageBox.addEventListener('click', () => {
            messageBox.classList.add('hidden');
        });

        // Haversineã®å…¬å¼ã§2ç‚¹é–“ã®è·é›¢ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•° (ãƒ¡ãƒ¼ãƒˆãƒ«å˜ä½)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // åœ°çƒã®åŠå¾„ (ãƒ¡ãƒ¼ãƒˆãƒ«)
            const Ï†1 = lat1 * Math.PI / 180;
            const Ï†2 = lat2 * Math.PI / 180;
            const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
            const Î”Î» = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const d = R * c; // è·é›¢ (ãƒ¡ãƒ¼ãƒˆãƒ«)
            return d;
        }

        // ãƒ«ãƒ¼ãƒˆã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
        generateRouteButton.addEventListener('click', () => {
            const distance = parseFloat(distanceInput.value);

            if (isNaN(distance) || distance <= 0) {
                showMessageBox('æœ‰åŠ¹ãªæ­©è¡Œè·é›¢ï¼ˆæ•°å­—ï¼‰ã‚’å…¥åŠ›ã—ã¦ã­ï¼');
                return;
            }

            // å¤ã„ãƒãƒªãƒ©ã‚¤ãƒ³ã¨ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
            if (routePolyline) { map.removeLayer(routePolyline); }
            if (nextTargetMarker) { map.removeLayer(nextTargetMarker); }

            currentRouteGuidance = [];
            currentGuidanceIndex = 0;
            guidanceDisplay.innerHTML = ''; // ä»¥å‰ã®æ¡ˆå†…ã‚’ã‚¯ãƒªã‚¢

            // åœ°å›³ä¸Šã®ãƒ«ãƒ¼ãƒˆåº§æ¨™ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®é…åˆ—
            const mapRouteCoordinates = [];
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ã‚«ãƒ¼ãŒã™ã§ã«å­˜åœ¨ã™ã‚Œã°ãã®ä½ç½®ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ã«ã€ãªã‘ã‚Œã°åœ°å›³ã®ä¸­å¿ƒã‚’ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ã«
            let currentLat = userMarker ? userMarker.getLatLng().lat : map.getCenter().lat;
            let currentLon = userMarker ? userMarker.getLatLng().lng : map.getCenter().lng;

            mapRouteCoordinates.push(L.latLng(currentLat, currentLon)); // ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹

            // è·é›¢ã«å¿œã˜ã¦æ¡ˆå†…ã®æ•°ã‚’èª¿æ•´ï¼ˆã‚ãã¾ã§ãƒ€ãƒŸãƒ¼ï¼‰
            const numSteps = Math.max(Math.floor(distance * 5), 3); // æœ€å°3ã‚¹ãƒ†ãƒƒãƒ—

            currentRouteGuidance.push('ãŠæ•£æ­©ã‚’é–‹å§‹ã—ã¾ã™ï¼è‰¯ã„ãŠå¤©æ°—ã ã­ï¼â˜€ï¸');

            // ãƒ€ãƒŸãƒ¼ã®ãƒ«ãƒ¼ãƒˆåº§æ¨™ã¨æ¡ˆå†…ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆ
            const degreePerKm = 0.009; // ç´„1kmã‚ãŸã‚Šã®ç·¯åº¦çµŒåº¦ã®å¤‰åŒ–é‡ï¼ˆæ¦‚ç®—ï¼‰
            for (let i = 0; i < numSteps; i++) {
                // ãƒ©ãƒ³ãƒ€ãƒ ãªæ–¹å‘ã¨è·é›¢ã§æ¬¡ã®ãƒã‚¤ãƒ³ãƒˆã‚’ç”Ÿæˆ
                const angle = Math.random() * 2 * Math.PI; // 0ã‹ã‚‰2Ï€ã®ãƒ©ãƒ³ãƒ€ãƒ ãªè§’åº¦
                const stepLengthKm = (Math.random() * 0.5 + 0.5) * (distance / numSteps); // å„ã‚¹ãƒ†ãƒƒãƒ—ã®é•·ã•ã‚’èª¿æ•´
                const latOffset = stepLengthKm * degreePerKm * Math.cos(angle);
                const lonOffset = stepLengthKm * degreePerKm * Math.sin(angle);

                currentLat += latOffset;
                currentLon += lonOffset;
                mapRouteCoordinates.push(L.latLng(currentLat, currentLon));

                const directions = ['å³', 'å·¦', 'ç›´é€²'];
                const direction = directions[Math.floor(Math.random() * directions.length)];
                const meters = Math.floor(Math.random() * 300) + 50; // 50mã€œ350m
                currentRouteGuidance.push(`${meters}må…ˆã‚’${direction}ã«æ›²ãŒã‚Šã¾ã™ã€‚`);
            }
            // ãƒ«ãƒ¼ãƒ—ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã™ã‚‹ãŸã‚ã€æœ€å¾Œã®ãƒã‚¤ãƒ³ãƒˆã‚’ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ã«è¿‘ã¥ã‘ã‚‹
            mapRouteCoordinates.push(L.latLng(mapRouteCoordinates[0].lat + (Math.random() - 0.5) * 0.001, mapRouteCoordinates[0].lng + (Math.random() - 0.5) * 0.001));
            currentRouteGuidance.push('ã‚´ãƒ¼ãƒ«ã ã‚ˆï¼ãŠæ•£æ­©ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ğŸŒ¸');


            // åœ°å›³ä¸Šã«ãƒãƒªãƒ©ã‚¤ãƒ³ã‚’æç”»
            routePolyline = L.polyline(mapRouteCoordinates, {color: 'blue', weight: 5, opacity: 0.7}).addTo(map);
            map.fitBounds(routePolyline.getBounds()); // ãƒ«ãƒ¼ãƒˆå…¨ä½“ãŒåã¾ã‚‹ã‚ˆã†ã«åœ°å›³ã‚’ã‚ºãƒ¼ãƒ 

            // æœ€åˆã®æ¡ˆå†…ã‚’è¡¨ç¤º
            updateGuidanceDisplay(); // æœ€åˆã®æ¡ˆå†…ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã«å‘¼ã³å‡ºã—
            showMessageBox(`ãŠæ•£æ­©ãƒ«ãƒ¼ãƒˆã‚’ç”Ÿæˆã—ãŸã‚ˆï¼å…¨${currentRouteGuidance.length}ã‚¹ãƒ†ãƒƒãƒ—ã ã‚ˆï¼`);

            // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹åŒ–
            startGuidanceButton.disabled = false;
            nextGuidanceButton.disabled = false;

            // è‡ªå‹•æ¡ˆå†…ã‚’åœæ­¢ã—ã¦ãŠãï¼ˆã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã§é–‹å§‹ï¼‰
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
        });

        // éŸ³å£°æ¡ˆå†…ã‚’é–‹å§‹ã™ã‚‹é–¢æ•° (è‡ªå‹•æ¡ˆå†…ã‚’åˆ¶å¾¡)
        startGuidanceButton.addEventListener('click', () => {
            if (currentRouteGuidance.length === 0) {
                showMessageBox('ã¾ãšãƒ«ãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ã­ï¼');
                return;
            }
            currentGuidanceIndex = 0; // æœ€åˆã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
            speakGuidance(currentRouteGuidance[currentGuidanceIndex]);
            updateGuidanceDisplay();

            // æ—¢å­˜ã®watchPositionãŒã‚ã‚Œã°ã‚¯ãƒªã‚¢
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }

            // æ¬¡ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆåœ°ç‚¹ã«ãƒãƒ¼ã‚«ãƒ¼ã‚’è¨­ç½®
            if (currentGuidanceIndex + 1 < routePolyline.getLatLngs().length) {
                const nextPoint = routePolyline.getLatLngs()[currentGuidanceIndex + 1];
                if (nextTargetMarker) { map.removeLayer(nextTargetMarker); }
                nextTargetMarker = L.marker(nextPoint, {
                    icon: L.divIcon({
                        className: 'custom-div-icon',
                        html: '<div style="background-color: orange; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;"></div>',
                        iconSize: [20, 20]
                    })
                }).addTo(map);
            }

            // ä½ç½®æƒ…å ±ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¿½è·¡ã‚’é–‹å§‹ (ã‚«ãƒ¼ãƒŠãƒ“é¢¨)
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLon = position.coords.longitude;

                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ã‚«ãƒ¼ã‚’æ›´æ–°
                    if (userMarker) {
                        userMarker.setLatLng([userLat, userLon]);
                    } else {
                        userMarker = L.marker([userLat, userLon]).addTo(map)
                            .bindPopup('ç¾åœ¨åœ°ã ã‚ˆï¼')
                            .openPopup();
                    }
                    map.panTo([userLat, userLon]); // åœ°å›³ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¿½å¾“ã•ã›ã‚‹

                    // æ¬¡ã®æ¡ˆå†…åœ°ç‚¹ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    if (currentGuidanceIndex < currentRouteGuidance.length - 1) {
                        const nextRoutePoint = routePolyline.getLatLngs()[currentGuidanceIndex + 1];
                        if (nextRoutePoint) {
                            const distanceToNext = calculateDistance(userLat, userLon, nextRoutePoint.lat, nextRoutePoint.lng);
                            const triggerDistance = 50; // 50ãƒ¡ãƒ¼ãƒˆãƒ«ä»¥å†…ã«è¿‘ã¥ã„ãŸã‚‰æ¬¡ã®æ¡ˆå†…ã‚’å‡ºã™

                            if (distanceToNext < triggerDistance) {
                                currentGuidanceIndex++;
                                speakGuidance(currentRouteGuidance[currentGuidanceIndex]);
                                updateGuidanceDisplay();

                                // æ¬¡ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒãƒ¼ã‚«ãƒ¼ã‚’æ›´æ–°
                                if (nextTargetMarker) { map.removeLayer(nextTargetMarker); }
                                if (currentGuidanceIndex + 1 < routePolyline.getLatLngs().length) {
                                    const newNextPoint = routePolyline.getLatLngs()[currentGuidanceIndex + 1];
                                    nextTargetMarker = L.marker(newNextPoint, {
                                        icon: L.divIcon({
                                            className: 'custom-div-icon',
                                            html: '<div style="background-color: orange; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;"></div>',
                                            iconSize: [20, 20]
                                        })
                                    }).addTo(map);
                                }
                            }
                        }
                    } else {
                        // ã™ã¹ã¦ã®æ¡ˆå†…ãŒçµ‚äº†ã—ãŸå ´åˆ
                        showMessageBox('ã™ã¹ã¦ã®æ¡ˆå†…ãŒçµ‚äº†ã—ãŸã‚ˆï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ğŸ˜Š');
                        navigator.geolocation.clearWatch(watchId);
                        watchId = null;
                        startGuidanceButton.disabled = true;
                        nextGuidanceButton.disabled = true;
                        if (nextTargetMarker) { map.removeLayer(nextTargetMarker); }
                    }
                },
                (error) => {
                    console.error('ä½ç½®æƒ…å ±ã®è¿½è·¡ã«å¤±æ•—ã—ãŸã‚ˆ:', 'ã‚³ãƒ¼ãƒ‰:', error.code, 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', error.message);
                    showMessageBox('ä½ç½®æƒ…å ±ã®è¿½è·¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã‚ˆã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ã­ï¼');
                    navigator.geolocation.clearWatch(watchId);
                    watchId = null;
                },
                { enableHighAccuracy: true, timeout: 20000, maximumAge: 1000, distanceFilter: 10 } // 10ãƒ¡ãƒ¼ãƒˆãƒ«ç§»å‹•ã™ã‚‹ã”ã¨ã«æ›´æ–°
            );
        });

        // æ¬¡ã®æ¡ˆå†…ã¸é€²ã‚€é–¢æ•° (æ‰‹å‹•æ¡ˆå†…ç”¨ã€è‡ªå‹•æ¡ˆå†…ã®å ´åˆã¯ä¸è¦ã«ãªã‚‹ãŒæ®‹ã—ã¦ãŠã)
        nextGuidanceButton.addEventListener('click', () => {
            if (currentGuidanceIndex < currentRouteGuidance.length - 1) {
                currentGuidanceIndex++;
                speakGuidance(currentRouteGuidance[currentGuidanceIndex]);
                updateGuidanceDisplay();
            } else {
                showMessageBox('ã™ã¹ã¦ã®æ¡ˆå†…ãŒçµ‚äº†ã—ãŸã‚ˆï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ğŸ˜Š');
                // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                startGuidanceButton.disabled = true;
                nextGuidanceButton.disabled = true;
            }
        });

        // æ¡ˆå†…ã‚’éŸ³å£°ã§èª­ã¿ä¸Šã’ã‚‹é–¢æ•°
        function speakGuidance(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ja-JP'; // æ—¥æœ¬èªã‚’è¨­å®š
                window.speechSynthesis.speak(utterance);
            } else {
                console.warn('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°åˆæˆã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
                showMessageBox('ã”ã‚ã‚“ã­ã€ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°åˆæˆã«å¯¾å¿œã—ã¦ã„ãªã„ã¿ãŸã„...ï¼');
            }
        }

        // æ¡ˆå†…è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateGuidanceDisplay() {
            guidanceDisplay.innerHTML = ''; // å…¨ã¦ã®æ¡ˆå†…ã‚’ã‚¯ãƒªã‚¢
            currentRouteGuidance.forEach((guidance, index) => {
                const p = document.createElement('p');
                p.textContent = `${index + 1}. ${guidance}`;
                if (index === currentGuidanceIndex) {
                    p.classList.add('font-bold', 'text-blue-700', 'text-lg'); // ç¾åœ¨ã®æ¡ˆå†…ã‚’å¼·èª¿
                }
                guidanceDisplay.appendChild(p);
            });
            // ç¾åœ¨ã®æ¡ˆå†…ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            const currentElement = guidanceDisplay.querySelector('.font-bold');
            if (currentElement) {
                currentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Leafletãƒãƒƒãƒ—ã‚’åˆæœŸåŒ–ã™ã‚‹é–¢æ•°
        function initializeMap(latitude, longitude) {
            console.log('initializeMap called. Type of L:', typeof L); // Debugging line
            mapLoading.classList.remove('hidden'); // åœ°å›³èª­ã¿è¾¼ã¿ä¸­è¡¨ç¤ºã‚’å‡ºã™

            // ãƒãƒƒãƒ—ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ç ´æ£„ã—ã¦å†ä½œæˆ
            if (map) {
                map.remove();
            }
            // åœ°å›³ã®ä¸­å¿ƒã‚’ç¾åœ¨åœ°ï¼ˆã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ã«è¨­å®šã—ã€ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’æŒ‡å®š
            map = L.map('map').setView([latitude, longitude], 15); // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«15

            // OpenStreetMapã®ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ã‚«ãƒ¼ã‚’åˆæœŸåŒ–ï¼ˆã¾ãŸã¯æ›´æ–°ï¼‰
            if (userMarker) {
                map.removeLayer(userMarker);
            }
            userMarker = L.marker([latitude, longitude]).addTo(map)
                .bindPopup('ç¾åœ¨åœ°ã ã‚ˆï¼')
                .openPopup();

            // åœ°å›³ãŒå®Œå…¨ã«èª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰ãƒ­ãƒ¼ãƒ‰è¡¨ç¤ºã‚’éš ã—ã€ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
            map.on('load', () => {
                map.invalidateSize(); // åœ°å›³ã®ã‚µã‚¤ã‚ºã‚’å†è¨ˆç®—
                mapLoading.classList.add('hidden'); // ãƒ­ãƒ¼ãƒ‰è¡¨ç¤ºã‚’éš ã™
                document.getElementById('map').classList.add('loaded'); // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹è¿½åŠ 
            });

            // ã‚‚ã—loadã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã—ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            setTimeout(() => {
                if (!mapLoading.classList.contains('hidden')) {
                    map.invalidateSize();
                    mapLoading.classList.add('hidden');
                    document.getElementById('map').classList.add('loaded');
                }
            }, 3000); // 3ç§’å¾Œã«å¼·åˆ¶çš„ã«ãƒ­ãƒ¼ãƒ‰è¡¨ç¤ºã‚’éš ã™
        }

        // LeafletãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚‹ã¾ã§å¾…ã¤é–¢æ•°
        function waitForLeaflet(callback, attempts = 0) {
            const maxAttempts = 20; // æœ€å¤§20å› (50ms * 20 = 1ç§’)
            if (typeof L !== 'undefined') {
                callback();
            } else if (attempts < maxAttempts) {
                setTimeout(() => waitForLeaflet(callback, attempts + 1), 50); // 50msã”ã¨ã«ãƒã‚§ãƒƒã‚¯
            } else {
                console.error('Leaflet (L) is still not defined after multiple attempts. Network issue or security policy blocking Leaflet CDN.');
                showMessageBox('ã”ã‚ã‚“ã­ï¼åœ°å›³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¡ã‚ƒã£ãŸã¿ãŸã„...ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã¿ã¦ã­ï¼');
            }
        }

        // DOMContentLoadedå¾Œã«Leafletã®æº–å‚™ã‚’å¾…ã£ã¦ã‹ã‚‰åˆæœŸåŒ–å‡¦ç†ã‚’é–‹å§‹
        document.addEventListener('DOMContentLoaded', () => {
            waitForLeaflet(() => {
                // LeafletãŒåˆ©ç”¨å¯èƒ½ã«ãªã£ãŸã‚‰åˆæœŸåŒ–å‡¦ç†ã‚’é–‹å§‹
                setTimeout(() => {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                const lat = position.coords.latitude;
                                const lon = position.coords.longitude;
                                console.log('ç¾åœ¨åœ°ã‚’å–å¾—ã—ãŸã‚ˆï¼ ç·¯åº¦:', lat, 'çµŒåº¦:', lon);
                                initializeMap(lat, lon); // ç¾åœ¨åœ°ã§ãƒãƒƒãƒ—ã‚’åˆæœŸåŒ–
                            },
                            (error) => {
                                console.error('ç¾åœ¨åœ°ã®å–å¾—ã«å¤±æ•—ã—ãŸã‚ˆ:', 'ã‚³ãƒ¼ãƒ‰:', error.code, 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', error.message);
                                let errorMessage = 'ç¾åœ¨åœ°ã®å–å¾—ã«å¤±æ•—ã—ãŸã‚ˆã€‚è¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ã­ï¼';
                                if (error.code === 1) {
                                    if (error.message.includes('permissions policy')) {
                                        errorMessage = 'ã”ã‚ã‚“ã­ï¼ã“ã®ç’°å¢ƒã§ã¯ä½ç½®æƒ…å ±ã®åˆ©ç”¨ãŒã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ã§ç„¡åŠ¹ã«ãªã£ã¦ã„ã‚‹ã¿ãŸã„ã€‚é€šå¸¸ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯å‹•ãã‚ˆï¼';
                                    } else {
                                        errorMessage = 'ä½ç½®æƒ…å ±ã®åˆ©ç”¨ãŒæ‹’å¦ã•ã‚ŒãŸã‚ˆã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ã­ï¼';
                                    }
                                } else if (error.code === 2) {
                                    errorMessage = 'ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ããªã„ã‚ˆã€‚é›»æ³¢çŠ¶æ³ãŒæ‚ªã„ã‹ã€GPSãŒã‚ªãƒ•ã«ãªã£ã¦ã„ã‚‹ã‹ã‚‚ï¼Ÿ';
                                } else if (error.code === 3) {
                                    errorMessage = 'ç¾åœ¨åœ°ã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ãŸã‚ˆã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã¿ã¦ã­ï¼';
                                }
                                showMessageBox(errorMessage);
                                // ç¾åœ¨åœ°ãŒå–å¾—ã§ããªã„å ´åˆã¯ã€æ±äº¬é§…å‘¨è¾ºã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¡¨ç¤º
                                initializeMap(35.681236, 139.767125); // æ±äº¬é§…ã®ç·¯åº¦çµŒåº¦
                            },
                            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                        );
                    } else {
                        console.warn('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
                        showMessageBox('ã”ã‚ã‚“ã­ã€ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ãªã„ã¿ãŸã„...ï¼');
                        // ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ãªã„å ´åˆã¯ã€æ±äº¬é§…å‘¨è¾ºã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¡¨ç¤º
                        initializeMap(35.681236, 139.767125); // æ±äº¬é§…ã®ç·¯åº¦çµŒåº¦
                    }
                }, 100); // Leafletæº–å‚™å¾Œã«å°‘ã—é…å»¶ã•ã›ã¦åˆæœŸåŒ–
            });
        });

    </script>
</body>
</html>

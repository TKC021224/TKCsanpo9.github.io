<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãŠæ•£æ­©ã‚¢ãƒ—ãƒª ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—</title>
    <!-- Tailwind CSS CDNã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSSã‚’èª­ã¿è¾¼ã¿ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        /* Interãƒ•ã‚©ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ï¼ˆTailwindã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã ãŒæ˜ç¤ºçš„ã«ï¼‰ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f8ff; /* æ·¡ã„é’ã®èƒŒæ™¯ */
        }
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        #map {
            /* Leafletåœ°å›³ãŒè¡¨ç¤ºã•ã‚Œã‚‹å ´æ‰€ */
            /* Tailwindã®h-64 (256px) / sm:h-80 (320px) ã«åˆã‚ã›ã¦å›ºå®šé«˜ã•ã‚’è¨­å®š */
            height: 320px; /* ã“ã“ã§å›ºå®šã®é«˜ã•ã‚’æŒ‡å®šï¼ */
            width: 100%; /* w-full ã¨åŒã˜ */
            border-radius: 1rem; /* rounded-xl ã¨åŒã˜ */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md ã¨åŒã˜ */
            background-color: #e0e0e0; /* åœ°å›³èª­ã¿è¾¼ã¿ä¸­ã®èƒŒæ™¯è‰² */
            display: block; /* ãƒ–ãƒ­ãƒƒã‚¯è¦ç´ ã¨ã—ã¦ç¢ºå®Ÿã«é«˜ã•ã‚’ç¢ºä¿ */
        }
        .scroll-container {
            max-height: 150px; /* æ¡ˆå†…ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ã®é«˜ã•åˆ¶é™ */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* iOSã§ã®ã‚¹ãƒ ãƒ¼ã‚ºãªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
        }
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆä»»æ„ï¼‰ */
        .scroll-container::-webkit-scrollbar {
            width: 8px;
        }
        .scroll-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .scroll-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .scroll-container::-webkit-scrollbar-thumb:hover {
            background: #555;
            border-radius: 10px;
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4 sm:p-6 bg-gradient-to-br from-blue-100 to-purple-100">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="w-full max-w-2xl bg-gradient-to-r from-purple-500 to-pink-500 text-white p-5 rounded-xl shadow-lg mb-6 text-center">
        <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight">
            ãŠæ•£æ­©ã‚¢ãƒ—ãƒª ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ— ğŸš¶â€â™€ï¸âœ¨
        </h1>
        <p class="mt-2 text-lg sm:text-xl font-medium">
            æ­©ããŸã„è·é›¢ã‚’å…¥åŠ›ã—ã¦ã€æ–°ã—ã„ãƒ«ãƒ¼ãƒˆã‚’è¦‹ã¤ã‘ã‚ˆã†ï¼
        </p>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="w-full max-w-2xl bg-white p-6 rounded-xl shadow-xl space-y-6">

        <!-- è·é›¢å…¥åŠ›ã¨ãƒœã‚¿ãƒ³ -->
        <section class="flex flex-col sm:flex-row items-center justify-center gap-4">
            <input
                type="number"
                id="distanceInput"
                placeholder="æ­©ããŸã„è·é›¢ (km) ã‚’å…¥åŠ›ã—ã¦ã­ï¼"
                class="flex-grow w-full sm:w-auto p-3 border-2 border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg text-gray-700 placeholder-gray-400 font-medium"
                min="0.1"
                step="0.1"
            >
            <button
                id="generateRouteButton"
                class="w-full sm:w-auto bg-gradient-to-r from-green-400 to-blue-500 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:from-green-500 hover:to-blue-600 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-300"
            >
                ãƒ«ãƒ¼ãƒˆã‚’ç”Ÿæˆã™ã‚‹ï¼ğŸ—ºï¸
            </button>
        </section>

        <!-- åœ°å›³è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <section class="relative w-full rounded-xl shadow-md overflow-hidden bg-gray-200 flex items-center justify-center">
            <div id="map" class="w-full"></div>
            <!-- åœ°å›³èª­ã¿è¾¼ã¿ä¸­ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
            <div id="mapLoading" class="absolute inset-0 flex items-center justify-center bg-gray-200 bg-opacity-75 text-gray-600 font-bold text-xl z-10">
                åœ°å›³ã‚’èª­ã¿è¾¼ã¿ä¸­... ğŸŒ
            </div>
        </section>

        <!-- éŸ³å£°æ¡ˆå†…ã¨æ¡ˆå†…è¡¨ç¤º -->
        <section class="bg-white p-5 rounded-xl shadow-md border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">
                éŸ³å£°æ¡ˆå†… ğŸ—£ï¸
            </h2>
            <div id="guidanceDisplay" class="scroll-container bg-blue-50 p-4 rounded-lg border border-blue-200 text-gray-700 text-base leading-relaxed mb-4">
                <p class="text-center text-gray-500">ãƒ«ãƒ¼ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã¨ã€ã“ã“ã«æ¡ˆå†…ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆï¼</p>
            </div>
            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <button
                    id="startGuidanceButton"
                    class="w-full sm:w-auto bg-gradient-to-r from-orange-400 to-red-500 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:from-orange-500 hover:to-red-600 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-orange-300"
                    disabled
                >
                    ãŠæ•£æ­©ã‚¹ã‚¿ãƒ¼ãƒˆï¼â–¶ï¸
                </button>
                <button
                    id="nextGuidanceButton"
                    class="w-full sm:w-auto bg-gradient-to-r from-purple-400 to-indigo-500 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:from-purple-500 hover:to-indigo-600 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-300"
                    disabled
                >
                    æ¬¡ã®æ¡ˆå†…ã¸ï¼ğŸ‘‰
                </button>
            </div>
        </section>

        <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ -->
        <div id="messageBox" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-8 rounded-xl shadow-2xl text-center max-w-sm mx-4">
                <p id="messageText" class="text-xl font-semibold text-gray-800 mb-6"></p>
                <button id="closeMessageBox" class="bg-blue-500 text-white font-bold py-3 px-6 rounded-full hover:bg-blue-600 transition duration-200">OKï¼</button>
            </div>
        </div>

    </main>

    <!-- Leaflet JavaScriptã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // DOMè¦ç´ ã®å–å¾—
        const distanceInput = document.getElementById('distanceInput');
        const generateRouteButton = document.getElementById('generateRouteButton');
        const guidanceDisplay = document.getElementById('guidanceDisplay');
        const startGuidanceButton = document.getElementById('startGuidanceButton');
        const nextGuidanceButton = document.getElementById('nextGuidanceButton');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const closeMessageBox = document.getElementById('closeMessageBox');
        const mapLoading = document.getElementById('mapLoading'); // æ–°ã—ãè¿½åŠ 

        let currentRouteGuidance = []; // ç”Ÿæˆã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆæ¡ˆå†…ãƒ†ã‚­ã‚¹ãƒˆã®é…åˆ—
        let currentGuidanceIndex = 0; // ç¾åœ¨ã®æ¡ˆå†…ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

        let map; // Leafletãƒãƒƒãƒ—ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
        let currentMarker; // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
        let currentRoutePolyline; // ç¾åœ¨ã®ãƒ«ãƒ¼ãƒˆç·šï¼ˆãƒãƒªãƒ©ã‚¤ãƒ³ï¼‰ã‚’ä¿æŒã™ã‚‹å¤‰æ•°

        // ç¾åœ¨ã®ç·¯åº¦çµŒåº¦ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
        let currentLat = 35.681236; // æ±äº¬é§…ã®ç·¯åº¦ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®š
        let currentLon = 139.767125; // æ±äº¬é§…ã®çµŒåº¦ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®š

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function showMessageBox(message) {
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã‚’é–‰ã˜ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        closeMessageBox.addEventListener('click', () => {
            messageBox.classList.add('hidden');
        });

        // ãƒ«ãƒ¼ãƒˆã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
        generateRouteButton.addEventListener('click', () => {
            const distance = parseFloat(distanceInput.value);

            if (isNaN(distance) || distance <= 0) {
                showMessageBox('æœ‰åŠ¹ãªæ­©è¡Œè·é›¢ï¼ˆæ•°å­—ï¼‰ã‚’å…¥åŠ›ã—ã¦ã­ï¼');
                return;
            }

            // ä»¥å‰ã®ãƒ«ãƒ¼ãƒˆç·šã‚’å‰Šé™¤
            if (currentRoutePolyline) {
                map.removeLayer(currentRoutePolyline);
            }

            // ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã®ãŸã‚ã€ãƒ€ãƒŸãƒ¼ã®ãƒ«ãƒ¼ãƒˆæ¡ˆå†…ã¨ãƒ«ãƒ¼ãƒˆåº§æ¨™ã‚’ç”Ÿæˆ
            currentRouteGuidance = [];
            currentGuidanceIndex = 0;
            guidanceDisplay.innerHTML = ''; // ä»¥å‰ã®æ¡ˆå†…ã‚’ã‚¯ãƒªã‚¢

            const numSteps = Math.max(Math.floor(distance * 5), 3); // æœ€å°3ã‚¹ãƒ†ãƒƒãƒ—

            currentRouteGuidance.push('ãŠæ•£æ­©ã‚’é–‹å§‹ã—ã¾ã™ï¼è‰¯ã„ãŠå¤©æ°—ã ã­ï¼â˜€ï¸');

            // ãƒ€ãƒŸãƒ¼ã®ãƒ«ãƒ¼ãƒˆåº§æ¨™ã‚’ç”Ÿæˆï¼ˆç¾åœ¨åœ°å‘¨è¾ºã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å‹•ãï¼‰
            const routeCoordinates = [[currentLat, currentLon]]; // ç¾åœ¨åœ°ã‚’å§‹ç‚¹ã¨ã™ã‚‹
            let tempLat = currentLat;
            let tempLon = currentLon;

            for (let i = 0; i < numSteps; i++) {
                const directions = ['å³', 'å·¦', 'ç›´é€²'];
                const direction = directions[Math.floor(Math.random() * directions.length)];
                const meters = Math.floor(Math.random() * 300) + 50; // 50mã€œ350m
                currentRouteGuidance.push(`${meters}må…ˆã‚’${direction}ã«æ›²ãŒã‚Šã¾ã™ã€‚`);

                // ãƒ€ãƒŸãƒ¼ã®åº§æ¨™ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ç”Ÿæˆï¼ˆéå¸¸ã«å°ã•ã„å€¤ã§ç·¯åº¦çµŒåº¦ã‚’å¤‰åŒ–ã•ã›ã‚‹ï¼‰
                // 1kmã¯ç´„0.009åº¦ç·¯åº¦ã€0.011åº¦çµŒåº¦ï¼ˆæ±äº¬ä»˜è¿‘ï¼‰
                const latChange = (Math.random() - 0.5) * 0.0005 * (meters / 100); // ç·¯åº¦ã‚’å¾®èª¿æ•´
                const lonChange = (Math.random() - 0.5) * 0.0005 * (meters / 100); // çµŒåº¦ã‚’å¾®èª¿æ•´
                tempLat += latChange;
                tempLon += lonChange;
                routeCoordinates.push([tempLat, tempLon]);
            }
            currentRouteGuidance.push('ã‚´ãƒ¼ãƒ«ã ã‚ˆï¼ãŠæ•£æ­©ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ğŸŒ¸');
            routeCoordinates.push([currentLat, currentLon]); // æœ€å¾Œã«ç¾åœ¨åœ°ã«æˆ»ã‚‹

            // ãƒ«ãƒ¼ãƒˆç·šã‚’åœ°å›³ã«æç”»
            currentRoutePolyline = L.polyline(routeCoordinates, {color: 'blue', weight: 5, opacity: 0.7}).addTo(map);
            map.fitBounds(currentRoutePolyline.getBounds()); // ãƒ«ãƒ¼ãƒˆå…¨ä½“ãŒç”»é¢ã«åã¾ã‚‹ã‚ˆã†ã«èª¿æ•´

            // æœ€åˆã®æ¡ˆå†…ã‚’è¡¨ç¤º
            guidanceDisplay.innerHTML = `<p class="font-bold text-blue-700">1. ${currentRouteGuidance[0]}</p>`;
            showMessageBox(`ãŠæ•£æ­©ãƒ«ãƒ¼ãƒˆã‚’ç”Ÿæˆã—ãŸã‚ˆï¼å…¨${currentRouteGuidance.length}ã‚¹ãƒ†ãƒƒãƒ—ã ã‚ˆï¼`);

            // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹åŒ–
            startGuidanceButton.disabled = false;
            nextGuidanceButton.disabled = false;
        });

        // éŸ³å£°æ¡ˆå†…ã‚’é–‹å§‹ã™ã‚‹é–¢æ•°
        startGuidanceButton.addEventListener('click', () => {
            if (currentRouteGuidance.length === 0) {
                showMessageBox('ã¾ãšãƒ«ãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ã­ï¼');
                return;
            }
            currentGuidanceIndex = 0; // æœ€åˆã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
            speakGuidance(currentRouteGuidance[currentGuidanceIndex]);
            updateGuidanceDisplay();
        });

        // æ¬¡ã®æ¡ˆå†…ã¸é€²ã‚€é–¢æ•°
        nextGuidanceButton.addEventListener('click', () => {
            if (currentGuidanceIndex < currentRouteGuidance.length - 1) {
                currentGuidanceIndex++;
                speakGuidance(currentRouteGuidance[currentGuidanceIndex]);
                updateGuidanceDisplay();
            } else {
                showMessageBox('ã™ã¹ã¦ã®æ¡ˆå†…ãŒçµ‚äº†ã—ãŸã‚ˆï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ğŸ˜Š');
                // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                startGuidanceButton.disabled = true;
                nextGuidanceButton.disabled = true;
            }
        });

        // æ¡ˆå†…ã‚’éŸ³å£°ã§èª­ã¿ä¸Šã’ã‚‹é–¢æ•°
        function speakGuidance(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ja-JP'; // æ—¥æœ¬èªã‚’è¨­å®š
                window.speechSynthesis.speak(utterance);
            } else {
                console.warn('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°åˆæˆã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
                showMessageBox('ã”ã‚ã‚“ã­ã€ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°åˆæˆã«å¯¾å¿œã—ã¦ã„ãªã„ã¿ãŸã„...ï¼');
            }
        }

        // æ¡ˆå†…è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateGuidanceDisplay() {
            guidanceDisplay.innerHTML = ''; // å…¨ã¦ã®æ¡ˆå†…ã‚’ã‚¯ãƒªã‚¢
            currentRouteGuidance.forEach((guidance, index) => {
                const p = document.createElement('p');
                p.textContent = `${index + 1}. ${guidance}`;
                if (index === currentGuidanceIndex) {
                    p.classList.add('font-bold', 'text-blue-700', 'text-lg'); // ç¾åœ¨ã®æ¡ˆå†…ã‚’å¼·èª¿
                }
                guidanceDisplay.appendChild(p);
            });
            // ç¾åœ¨ã®æ¡ˆå†…ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            const currentElement = guidanceDisplay.querySelector('.font-bold');
            if (currentElement) {
                currentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Leafletãƒãƒƒãƒ—ã‚’åˆæœŸåŒ–ã™ã‚‹é–¢æ•°
        function initializeMap(latitude, longitude) {
            console.log('initializeMap called. Type of L:', typeof L); // Debugging line
            mapLoading.classList.remove('hidden'); // åœ°å›³èª­ã¿è¾¼ã¿ä¸­è¡¨ç¤ºã‚’å‡ºã™

            // ãƒãƒƒãƒ—ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ç ´æ£„ã—ã¦å†ä½œæˆ
            if (map) {
                map.remove();
            }
            // åœ°å›³ã®ä¸­å¿ƒã‚’ç¾åœ¨åœ°ï¼ˆã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ã«è¨­å®šã—ã€ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã‚’æŒ‡å®š
            map = L.map('map').setView([latitude, longitude], 15); // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«15

            // OpenStreetMapã®ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
            if (currentMarker) {
                map.removeLayer(currentMarker); // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
            }
            currentMarker = L.marker([latitude, longitude]).addTo(map)
                .bindPopup('ç¾åœ¨åœ°ã ã‚ˆï¼')
                .openPopup();

            // ãƒãƒƒãƒ—ã®è¡¨ç¤ºã‚’å¼·åˆ¶çš„ã«æ›´æ–°ï¼ˆä¸€éƒ¨ç’°å¢ƒã§è¡¨ç¤ºã•ã‚Œãªã„å•é¡Œå¯¾ç­–ï¼‰
            // Leafletã¯ã‚³ãƒ³ãƒ†ãƒŠã®ã‚µã‚¤ã‚ºãŒç¢ºå®šã—ãŸå¾Œã«invalidateSizeã‚’å‘¼ã¶å¿…è¦ãŒã‚ã‚‹
            // åœ°å›³ã‚¿ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰ãƒ­ãƒ¼ãƒ‰è¡¨ç¤ºã‚’éš ã™
            map.on('load', () => {
                map.invalidateSize(); // åœ°å›³ã®ã‚µã‚¤ã‚ºã‚’å†è¨ˆç®—
                mapLoading.classList.add('hidden'); // ãƒ­ãƒ¼ãƒ‰è¡¨ç¤ºã‚’éš ã™
            });

            // ã‚‚ã—loadã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã—ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆç¨€ã«ç™ºç”Ÿï¼‰
            setTimeout(() => {
                if (!mapLoading.classList.contains('hidden')) {
                    map.invalidateSize();
                    mapLoading.classList.add('hidden');
                }
            }, 3000); // 3ç§’å¾Œã«å¼·åˆ¶çš„ã«ãƒ­ãƒ¼ãƒ‰è¡¨ç¤ºã‚’éš ã™
        }

        // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã«ç¾åœ¨åœ°ã‚’å–å¾—ã—ã€ãƒãƒƒãƒ—ã‚’åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => { // window.onload ã‹ã‚‰å¤‰æ›´
            // initializeMapã®å‘¼ã³å‡ºã—ã‚’å°‘ã—é…ã‚‰ã›ã‚‹
            setTimeout(() => {
                // LãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
                if (typeof L === 'undefined') {
                    console.error('Leaflet (L) is not defined. Map cannot be initialized. This might be due to a network issue or security policy blocking Leaflet CDN.');
                    showMessageBox('ã”ã‚ã‚“ã­ï¼åœ°å›³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¡ã‚ƒã£ãŸã¿ãŸã„...ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã¿ã¦ã­ï¼');
                    // LãŒå®šç¾©ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€åœ°å›³ã®åˆæœŸåŒ–ã‚’è©¦ã¿ãªã„
                    return;
                }

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            currentLat = position.coords.latitude;
                            currentLon = position.coords.longitude;
                            console.log('ç¾åœ¨åœ°ã‚’å–å¾—ã—ãŸã‚ˆï¼ ç·¯åº¦:', currentLat, 'çµŒåº¦:', currentLon);
                            initializeMap(currentLat, currentLon); // ç¾åœ¨åœ°ã§ãƒãƒƒãƒ—ã‚’åˆæœŸåŒ–
                        },
                        (error) => {
                            console.error('ç¾åœ¨åœ°ã®å–å¾—ã«å¤±æ•—ã—ãŸã‚ˆ:', 'ã‚³ãƒ¼ãƒ‰:', error.code, 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', error.message);
                            let errorMessage = 'ç¾åœ¨åœ°ã®å–å¾—ã«å¤±æ•—ã—ãŸã‚ˆã€‚è¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ã­ï¼';
                            if (error.code === 1) {
                                if (error.message.includes('permissions policy')) {
                                    errorMessage = 'ã”ã‚ã‚“ã­ï¼ã“ã®ç’°å¢ƒã§ã¯ä½ç½®æƒ…å ±ã®åˆ©ç”¨ãŒã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ã§ç„¡åŠ¹ã«ãªã£ã¦ã„ã‚‹ã¿ãŸã„ã€‚é€šå¸¸ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯å‹•ãã‚ˆï¼';
                                } else {
                                    errorMessage = 'ä½ç½®æƒ…å ±ã®åˆ©ç”¨ãŒæ‹’å¦ã•ã‚ŒãŸã‚ˆã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ã­ï¼';
                                }
                            } else if (error.code === 2) {
                                errorMessage = 'ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ããªã„ã‚ˆã€‚é›»æ³¢çŠ¶æ³ãŒæ‚ªã„ã‹ã€GPSãŒã‚ªãƒ•ã«ãªã£ã¦ã„ã‚‹ã‹ã‚‚ï¼Ÿ';
                            } else if (error.code === 3) {
                                errorMessage = 'ç¾åœ¨åœ°ã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ãŸã‚ˆã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã¿ã¦ã­ï¼';
                            }
                            showMessageBox(errorMessage);
                            // ç¾åœ¨åœ°ãŒå–å¾—ã§ããªã„å ´åˆã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ±äº¬é§…å‘¨è¾ºã§è¡¨ç¤º
                            initializeMap(currentLat, currentLon); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ç·¯åº¦çµŒåº¦ã§ãƒãƒƒãƒ—ã‚’åˆæœŸåŒ–
                        },
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                    );
                } else {
                    console.warn('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
                    showMessageBox('ã”ã‚ã‚“ã­ã€ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ãªã„ã¿ãŸã„...ï¼');
                    // ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ãªã„å ´åˆã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ±äº¬é§…å‘¨è¾ºã§è¡¨ç¤º
                    initializeMap(currentLat, currentLon); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ç·¯åº¦çµŒåº¦ã§ãƒãƒƒãƒ—ã‚’åˆæœŸåŒ–
                }
            }, 100); // DOMContentLoadedå¾Œã«å°‘ã—é…å»¶ã•ã›ã¦åˆæœŸåŒ–
        });

    </script>
</body>
</html>
